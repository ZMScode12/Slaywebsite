<!DOCTYPE html>
<html>
<head>
  <title>Dynamic To-Do Tabs 😎</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --default-moving: linear-gradient(135deg, #5b00ff, #ff0066, #00f2ff); }

    body {
      font-family: Arial, sans-serif;
      color: white;
      text-align: center;
      padding: 40px;
      transition: background 0.6s ease;
      background: var(--default-moving);
      background-size: 400% 400%;
      animation: gradientMove 12s ease infinite;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .hidden { display: none; }
    input, button { padding: 10px; margin: 6px; border-radius: 8px; border: none; font-size: 15px; }
    button { cursor: pointer; }
    .list-button { background-color: white; color: #6b5bff; }

    ul { list-style: none; padding: 0; margin-top: 10px; }
    li { margin: 10px; background: rgba(255,255,255,0.14); padding: 10px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    input[type="text"] { flex: 1; margin-left: 10px; border-radius:6px; padding:8px; border:none; }

    .gradient-option { width: 86px; height: 44px; border-radius: 10px; display: inline-block; margin: 6px; cursor: pointer; border: 3px solid transparent; box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
    .gradient-option.selected { border-color: white; transform: translateY(-3px); }

    .tabs { margin-bottom: 18px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center; }
    .tab-btn { background: rgba(255,255,255,0.12); color: white; border-radius: 12px; padding: 8px 12px; cursor: pointer; display:inline-flex; align-items:center; gap:6px; border: none; }
    .tab-btn.active { background: white; color: #6b5bff; font-weight:600; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }

    .control-small { padding:6px 8px; font-size:14px; border-radius:8px; }

    /* Top panels container - inline, side-by-side, pushes content down (no overlap) */
    #topPanels {
      display: flex;
      gap: 20px;
      justify-content: space-between;
      align-items: flex-start;
      width: calc(100% - 80px); /* body padding 40 each side */
      margin: 0 auto 18px auto;
      box-sizing: border-box;
      max-width: 1200px;
    }

    .panel {
      width: 48%;
      background: rgba(0, 0, 0, 0.32);
      border-radius: 12px;
      color: white;
      text-align: left;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      overflow: visible;
    }

    /* header bar that stays visible (click to toggle body) */
    .panel-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      cursor: pointer;
      user-select: none;
      border-radius: 12px;
      background: linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02));
      font-weight: 600;
      gap:8px;
    }
    .panel-header .title { text-align:center; flex:1; font-size:16px; }
    .chev { width:20px; height:20px; display:inline-block; transition: transform 220ms ease; }

    /* panel body uses max-height animation for smooth slide */
    .panel-body {
      overflow: hidden;
      max-height: 0;
      transition: max-height 320ms cubic-bezier(.25,.8,.25,1), padding 220ms ease;
      padding: 0 12px;
    }
    .panel-body.open {
      padding: 12px;
    }

    /* when header toggled, rotate arrow */
    .open .chev { transform: rotate(180deg); }

    /* Quick Links inner */
    #quickLinksList { padding-left: 6px; max-height: 240px; overflow-y: auto; margin-bottom: 8px; }
    #quickLinksList li { display:flex; justify-content: space-between; align-items: center; gap:8px; margin-bottom:6px; font-size:14px; }
    #quickLinksList a { color: #ffd; text-decoration: underline; max-width: 160px; word-break: break-word; }

    /* Planner inner */
    #plannerList { padding-left: 6px; max-height: 240px; overflow-y: auto; margin-bottom: 8px; }
    #plannerList li { display:flex; justify-content: space-between; align-items: center; gap:8px; margin-bottom:6px; font-size:14px; }
    .task-text { max-width: 160px; word-break: break-word; display:block; }
    .task-date { font-size: 12px; opacity: 0.85; margin-top: 6px; display:block; }

    /* inputs inside panels */
    .panel .inputs { display:flex; flex-direction:column; gap:6px; margin-top:6px; }
    .panel input { width: 100%; border-radius: 8px; padding:8px; margin:0; border:none; box-sizing: border-box; }
    .panel .row { display:flex; gap:6px; }
    .panel .row .small-btn { padding:6px 8px; font-size:13px; border-radius:6px; }

    /* small responsive tweak so panels stack on narrow screens */
    @media (max-width: 880px) {
      #topPanels { flex-direction: column; gap: 12px; width: calc(100% - 40px); }
      .panel { width: 100%; }
      body { padding: 20px; }
    }
  </style>
</head>
<body>

  <!-- Sign up / Login -->
  <div id="signup">
    <h1>Sign Up 💫</h1>
    <input type="text" id="username" placeholder="Enter a username"><br>
    <input type="password" id="password" placeholder="Enter a password"><br>

    <p style="margin-top:8px">Pick your background style (or keep the moving default):</p>
    <div id="gradients">
      <div class="gradient-option" data-bg="linear-gradient(to right, #ff7e5f, #feb47b)" style="background: linear-gradient(to right, #ff7e5f, #feb47b)" title="Sunset"></div>
      <div class="gradient-option" data-bg="linear-gradient(to right, #2193b0, #6dd5ed)" style="background: linear-gradient(to right, #2193b0, #6dd5ed)" title="Ocean"></div>
      <div class="gradient-option" data-bg="linear-gradient(to right, #0f2027, #203a43, #2c5364)" style="background: linear-gradient(to right, #0f2027, #203a43, #2c5364)" title="Galaxy"></div>
      <div class="gradient-option" data-bg="linear-gradient(to right, #ff9a9e, #fad0c4)" style="background: linear-gradient(to right, #ff9a9e, #fad0c4)" title="Blossom"></div>
      <div class="gradient-option" data-bg="default" id="defaultOption" style="background: linear-gradient(135deg,#5b00ff,#ff0066,#00f2ff)" title="Keep moving gradient"></div>
    </div>
    <div style="margin-top:8px">
      <button onclick="createAccount()">Create Account</button>
      <button class="control-small" onclick="useDefaultNow()">Don't change — keep moving</button>
    </div>

    <p style="margin-top:12px">Already have an account? <a href="#" onclick="showLogin()">Log in</a></p>
  </div>

  <div id="login" class="hidden">
    <h1>Login 💫</h1>
    <input type="text" id="loginUsername" placeholder="Enter username"><br>
    <input type="password" id="loginPassword" placeholder="Enter password"><br>
    <div style="margin-top:8px">
      <button onclick="login()">Log In</button>
      <button class="control-small" onclick="showSignup()">Sign up</button>



    </div>
  </div>

  <!-- Top inline panels: Quick Links (left) + Planner (right) -->
  <div id="topPanels" class="hidden" aria-hidden="true">
    <!-- Quick Links panel -->
    <div id="quickLinks" class="panel" aria-hidden="true">
      <div class="panel-header" onclick="togglePanel('quickLinks')">
        <div style="width:20px"></div>
        <div class="title">Quick Links</div>
        <div class="chev">▾</div>
      </div>
      <div id="quickLinksBody" class="panel-body" aria-hidden="true">
        <ul id="quickLinksList"></ul>

        <div class="inputs">
          <input type="text" id="quickLinkName" placeholder="Link name (e.g. Spotify)">
          <input type="text" id="quickLinkURL" placeholder="URL (e.g. https://spotify.com)">
          <div class="row">
            <button class="small-btn" onclick="addQuickLink()">Add</button>
            <button class="small-btn" onclick="clearQuickLinks()">Clear All</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Planner panel -->
    <div id="planner" class="panel" aria-hidden="true">
      <div class="panel-header" onclick="togglePanel('planner')">
        <div style="width:20px"></div>
        <div class="title">Planner</div>
        <div class="chev">▾</div>
      </div>
      <div id="plannerBody" class="panel-body" aria-hidden="true">
        <ul id="plannerList"></ul>

        <div class="inputs">
          <input type="text" id="plannerTask" placeholder="Add a task...">
          <input type="date" id="plannerDate">
          <div class="row">
            <button class="small-btn" onclick="addPlannerTask()">Add</button>
            <button class="small-btn" onclick="clearPlanner()">Clear All</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- To-do lists -->
  <div id="todo" class="hidden">
    <div id="todoHeader"></div> <!-- Dynamic welcome + New List -->
    <div class="tabs" id="tabsContainer"></div> <!-- List tabs -->
    <div id="listsContainer"></div> <!-- Tasks for active tab -->
    <div id="background-picker" class="hidden" style="margin-top:12px;">
      <label for="bg-select">Choose Background:</label>
      <select id="bg-select" onchange="changeBackground(this.value)">
        <option value="default">Default</option>
        <option value="linear-gradient(to right, #ff7e5f, #feb47b)">Sunset</option>
        <option value="linear-gradient(to right, #2193b0, #6dd5ed)">Ocean</option>
        <option value="linear-gradient(to right, #0f2027, #203a43, #2c5364)">Galaxy</option>
        <option value="linear-gradient(to right, #ff9a9e, #fad0c4)">Blossom</option>
      </select>
    </div>
    <div style="margin-top:12px">
      <button onclick="logout()">Logout</button>
    </div>
  </div>

<script>
/* --------- State --------- */
/* currentUser stores the user's unique id (we use password as id) */
let currentUser = localStorage.getItem('currentUser'); // this will be password (unique id)
let currentUserName = null; // display name (username)
let allLists = [];
let activeListIndex = 0;
let pickedBackground = 'default';

/* --------- util escape --------- */
function escapeHtml(str) { return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* --------- Gradient selection --------- */
const gradientEls = Array.from(document.querySelectorAll('.gradient-option'));
function setPickedBgValue(val) {
  pickedBackground = val;
  gradientEls.forEach(el => el.classList.toggle('selected', el.getAttribute('data-bg') === val));
  applyBackgroundPreview(val);
}
function applyBackgroundPreview(val) {
  if (val === 'default') {
    document.body.style.background = getComputedStyle(document.documentElement).getPropertyValue('--default-moving').trim();
    document.body.style.backgroundSize = '400% 400%';
    document.body.style.animation = 'gradientMove 12s ease infinite';
  } else {
    document.body.style.background = val;
    document.body.style.backgroundSize = '';
    document.body.style.animation = '';
  }
}
gradientEls.forEach(el => el.addEventListener('click', () => setPickedBgValue(el.getAttribute('data-bg'))));
function useDefaultNow() { setPickedBgValue('default'); }

/* --------- Panel toggle logic (slide down) --------- */
function togglePanel(panelId) {
  const panel = document.getElementById(panelId);
  const body = document.getElementById(panelId + 'Body');
  const header = panel.querySelector('.panel-header');
  const chevron = header.querySelector('.chev');
  const open = body.classList.contains('open');

  if (open) {
    // close
    body.style.maxHeight = body.scrollHeight + 'px'; // set current height to enable transition
    requestAnimationFrame(() => {
      body.style.maxHeight = '0px';
      body.classList.remove('open');
      panel.classList.remove('open');
      body.setAttribute('aria-hidden', 'true');
    });
  } else {
    // open
    body.classList.add('open');
    panel.classList.add('open');
    body.setAttribute('aria-hidden', 'false');
    // set to measured scrollHeight to animate
    body.style.maxHeight = body.scrollHeight + 'px';
    // after transition remove explicit max-height to allow internal resizing if needed
    setTimeout(() => { if (body.classList.contains('open')) body.style.maxHeight = body.scrollHeight + 'px'; }, 330);
  }
}

/* --------- Load session (if any) --------- */
if (currentUser) {
  // get username for display
  const usersTemp = JSON.parse(localStorage.getItem('users') || '{}');
  if (usersTemp[currentUser]) currentUserName = usersTemp[currentUser].username || null;
  showTodo();
  checkTopPanelsVisibility();
  loadAllLists();
  renderQuickLinks();
  renderPlanner();
}

/* --------- Account functions (password used as unique id) --------- */
function createAccount() {
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!user || !pass) { alert('Please fill both username and password'); return; }

  const users = JSON.parse(localStorage.getItem('users') || '{}');

  // Use password as the internal unique id. Enforce unique passwords.
  if (users[pass]) {
    alert('That password is already in use. Please pick a different password.');
    return;
  }

  users[pass] = {
    username: user,
    password: pass,
    lists: [{ name: 'My First List', tasks: [] }],
    background: pickedBackground,
    quickLinks: [],
    planner: [] // per-account planner tasks stored as array of {text, date}
  };
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('currentUser', pass);
  currentUser = pass;
  currentUserName = user;
  loadAllLists();
  checkTopPanelsVisibility();
  showTodo();
  renderLists();
  renderQuickLinks();
  renderPlanner();
}

function showLogin() {
  document.getElementById('signup').classList.add('hidden');
  document.getElementById('login').classList.remove('hidden');
}
function showSignup() {
  document.getElementById('login').classList.add('hidden');
  document.getElementById('signup').classList.remove('hidden');
}
function login() {
  const userInput = document.getElementById('loginUsername').value.trim();
  const pass = document.getElementById('loginPassword').value.trim();
  const users = JSON.parse(localStorage.getItem('users') || '{}');

  // We identify accounts by password (unique). Ensure a matching account exists and username matches what user typed.
  if (!users[pass] || users[pass].username !== userInput) {
    alert('Invalid username or password');
    return;
  }

  localStorage.setItem('currentUser', pass);
  currentUser = pass;
  currentUserName = users[pass].username || null;
  loadAllLists();
  checkTopPanelsVisibility();
  showTodo();
  renderLists();
  renderQuickLinks();
  renderPlanner();
}

/* --------- Show To-do --------- */
function showTodo() {
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser]) return;

  const user = users[currentUser];
  applyBackgroundPreview(user.background || 'default');

  document.getElementById('signup').classList.add('hidden');
  document.getElementById('login').classList.add('hidden');
  document.getElementById('todo').classList.remove('hidden');

  // show the top panels container (closed by default)
  const top = document.getElementById('topPanels');
  top.classList.remove('hidden');
  top.setAttribute('aria-hidden','false');

  // display username (not password)
  const displayName = currentUserName || (users[currentUser] && users[currentUser].username) || currentUser;
  document.getElementById('todoHeader').innerHTML = `
    <h1>Welcome, ${escapeHtml(displayName)}!</h1>
    <div style="margin-top:8px">
      <button onclick="createNewList()" class="list-button">+ New To-Do List</button>
      <button class="control-small" onclick="openBackgroundPicker()">Change background</button>
    </div>
  `;
}

/* --------- Quick Links (per-account) --------- */
function renderQuickLinks() {
  const top = document.getElementById('topPanels');
  const quickDiv = document.getElementById('quickLinks');
  const listEl = document.getElementById('quickLinksList');
  listEl.innerHTML = '';

  // If not logged in, hide the panel completely
  if (!currentUser) {
    checkTopPanelsVisibility();
    return;
  }

  quickDiv.classList.remove('hidden');

  const users = JSON.parse(localStorage.getItem('users') || '{}');
  const links = (users[currentUser] && users[currentUser].quickLinks) || [];

  links.forEach((link, i) => {
    const li = document.createElement('li');
    const nameDisplay = link.name
      ? (link.name.length > 36 ? link.name.slice(0, 33) + '...' : link.name)
      : (link.url.length > 36 ? link.url.slice(0, 33) + '...' : link.url);
    li.innerHTML = `
      <div style="display:flex; flex-direction:column; gap:4px;">
        <a href="${escapeHtml(link.url)}" target="_blank" rel="noopener noreferrer">
          ${escapeHtml(nameDisplay)}
        </a>
        <span style="font-size:12px; opacity:0.9;">${escapeHtml(link.url)}</span>
      </div>
      <div>
        <button class="small-btn" onclick="editQuickLink(${i})" title="Edit link">✏️</button>
        <button class="small-btn" onclick="removeQuickLink(${i})" title="Remove link">🗑</button>
      </div>
    `;
    listEl.appendChild(li);
  });

  checkTopPanelsVisibility();
}


function addQuickLink() {
  const name = document.getElementById('quickLinkName').value.trim();
  let url = document.getElementById('quickLinkURL').value.trim();
  if (!name || !url) { alert('Please enter both a name and a URL'); return; }

  if (!/^https?:\/\//i.test(url)) {
    url = 'https://' + url;
  }

  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser]) return alert('No user session');

  users[currentUser].quickLinks = users[currentUser].quickLinks || [];
  users[currentUser].quickLinks.push({ name, url });
  localStorage.setItem('users', JSON.stringify(users));

  document.getElementById('quickLinkName').value = '';
  document.getElementById('quickLinkURL').value = '';
  renderQuickLinks();
}

function editQuickLink(index) {
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser] || !users[currentUser].quickLinks) return;
  const link = users[currentUser].quickLinks[index];
  if (!link) return;
  const newName = prompt('Edit link name:', link.name || '') || link.name || '';
  let newUrl = prompt('Edit link URL:', link.url || '') || link.url || '';
  if (!newName || !newUrl) return alert('Name and URL cannot be empty');
  if (!/^https?:\/\//i.test(newUrl)) newUrl = 'https://' + newUrl;
  users[currentUser].quickLinks[index] = { name: newName.trim(), url: newUrl.trim() };
  localStorage.setItem('users', JSON.stringify(users));
  renderQuickLinks();
}

function removeQuickLink(index) {
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser] || !users[currentUser].quickLinks) return;
  users[currentUser].quickLinks.splice(index, 1);
  localStorage.setItem('users', JSON.stringify(users));
  renderQuickLinks();
}

function clearQuickLinks() {
  if (!confirm('Clear all quick links for this account?')) return;
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser]) return;
  users[currentUser].quickLinks = [];
  localStorage.setItem('users', JSON.stringify(users));
  renderQuickLinks();
}

/* --------- Planner (per-account) --------- */
function renderPlanner() {
  const top = document.getElementById('topPanels');
  const plannerDiv = document.getElementById('planner');
  const listEl = document.getElementById('plannerList');
  listEl.innerHTML = '';

  // hide top area if not logged
  if (!currentUser) {
    plannerDiv.setAttribute('aria-hidden','true');
    top.classList.add('hidden');
    top.setAttribute('aria-hidden','true');
    return;
  }

  const users = JSON.parse(localStorage.getItem('users') || '{}');
  const tasks = (users[currentUser] && users[currentUser].planner) || [];

  // sort by date if present
  tasks.sort((a, b) => {
    if (!a.date && !b.date) return 0;
    if (!a.date) return 1;
    if (!b.date) return -1;
    return new Date(a.date) - new Date(b.date);
  });

  tasks.forEach((task, i) => {
    const li = document.createElement('li');
    const textHtml = `<span class="task-text">${escapeHtml(task.text)}</span>`;
    const dateHtml = task.date ? `<span class="task-date">${escapeHtml(task.date)}</span>` : `<span class="task-date">No date</span>`;
    li.innerHTML = `<div style="display:flex; flex-direction:column; gap:6px;">${textHtml}${dateHtml}</div>
      <div style="display:flex; gap:6px; align-items:center;">
        <button class="small-btn" onclick="editPlannerTask(${i})" title="Edit">✏️</button>
        <button class="small-btn" onclick="removePlannerTask(${i})" title="Remove">🗑</button>
      </div>`;
    listEl.appendChild(li);
  });
}

function addPlannerTask() {
  const textEl = document.getElementById('plannerTask');
  const dateEl = document.getElementById('plannerDate');
  const text = textEl.value.trim();
  const date = dateEl.value || '';

  if (!text) return alert('Enter a task first!');

  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser]) return alert('No user session');

  users[currentUser].planner = users[currentUser].planner || [];
  users[currentUser].planner.push({ text, date });
  localStorage.setItem('users', JSON.stringify(users));
  textEl.value = '';
  dateEl.value = '';
  renderPlanner();
}

function editPlannerTask(index) {
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser] || !users[currentUser].planner) return;
  const task = users[currentUser].planner[index];
  if (!task) return;
  const newText = prompt('Edit task:', task.text || '') || task.text;
  const newDate = prompt('Edit date (YYYY-MM-DD, leave empty for none):', task.date || '') || task.date || '';
  users[currentUser].planner[index] = { text: newText.trim(), date: newDate.trim() };
  localStorage.setItem('users', JSON.stringify(users));
  renderPlanner();
}

function removePlannerTask(index) {
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser]) return;
  users[currentUser].planner.splice(index, 1);
  localStorage.setItem('users', JSON.stringify(users));
  renderPlanner();
}

function clearPlanner() {
  if (!confirm('Clear all planner tasks?')) return;
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser]) return;
  users[currentUser].planner = [];
  localStorage.setItem('users', JSON.stringify(users));
  renderPlanner();
}

/* --------- Background Picker --------- */
function openBackgroundPicker() {
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  const bg = (users[currentUser] && users[currentUser].background) || 'default';
  document.getElementById('background-picker').classList.toggle('hidden');
  document.getElementById('bg-select').value = bg;
}
function changeBackground(value) {
  document.body.style.background = value === 'default'
    ? getComputedStyle(document.documentElement).getPropertyValue('--default-moving').trim()
    : value;

  // save
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (currentUser) {
    users[currentUser] = users[currentUser] || {};
    users[currentUser].background = value;
    localStorage.setItem('users', JSON.stringify(users));
  }
}

/* --------- Logout --------- */
function logout() {
  saveAllLists();
  localStorage.removeItem('currentUser');
  currentUser = null;
  currentUserName = null;
  allLists = [];
  activeListIndex = 0;
  setPickedBgValue('default');
  document.getElementById('todo').classList.add('hidden');
  document.getElementById('login').classList.remove('hidden');
  document.getElementById('listsContainer').innerHTML = "";
  document.getElementById('tabsContainer').innerHTML = "";
  document.getElementById('todoHeader').innerHTML = "";
  document.getElementById('topPanels').classList.add('hidden');
  document.getElementById('topPanels').setAttribute('aria-hidden','true');
}

/* --------- Lists --------- */
function saveAllLists() {
  if (!currentUser) return;
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  users[currentUser].lists = allLists;
  localStorage.setItem('users', JSON.stringify(users));
}

function loadAllLists() {
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser]) { allLists = []; return; }
  allLists = users[currentUser].lists || [];
  allLists = allLists.map(l => (typeof l === 'string' ? { name: l, tasks: [] } : (l.name ? l : { name: 'Untitled', tasks: l.tasks || [] })));
  activeListIndex = 0;
}

/* Render */
function renderLists() {
  renderTabs();
  renderActiveList();
}

function renderTabs() {
  const tabs = document.getElementById('tabsContainer');
  tabs.innerHTML = "";
  allLists.forEach((list, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (i === activeListIndex ? ' active' : '');
    btn.textContent = list.name || `List ${i+1}`;
    btn.onclick = () => { activeListIndex = i; renderLists(); };
    tabs.appendChild(btn);

    const renameBtn = document.createElement('button');
    renameBtn.className = 'control-small';
    renameBtn.textContent = '✏️';
    renameBtn.onclick = (e) => { e.stopPropagation(); renameList(i); };
    tabs.appendChild(renameBtn);

    const delBtn = document.createElement('button');
    delBtn.className = 'control-small';
    delBtn.textContent = '🗑';
    delBtn.onclick = (e) => { e.stopPropagation(); confirmDeleteList(i); };
    tabs.appendChild(delBtn);
  });
}

function renderActiveList() {
  const container = document.getElementById('listsContainer');
  container.innerHTML = "";
  if (allLists.length === 0) {
    container.innerHTML = `<div style="padding:20px; border-radius:12px; background: rgba(0,0,0,0.15)">
      <h2>No To-Do Lists Yet 😎</h2>
      <p>Click "+ New To-Do List" to start.</p>
    </div>`;
    return;
  }
  const index = activeListIndex;
  const list = allLists[index];
  const listDiv = document.createElement('div');
  listDiv.innerHTML = `
    <h2 style="margin-bottom:6px">${escapeHtml(list.name)}</h2>
    <div style="margin-bottom:8px; display:flex; gap:6px; align-items:center;">
      <input type="text" id="newTask_${index}" placeholder="Add a task..." style="flex:1;">
      <input type="date" id="newTaskDate_${index}">
      <button onclick="addTask(${index})">Add</button>
    </div>
    <ul id="list_${index}"></ul>
  `;
  container.appendChild(listDiv);

  const ul = document.getElementById(`list_${index}`);
  list.tasks.forEach((task, tIdx) => {
    const li = document.createElement('li');
    const dateLabel = task.dueDate ? `<span style="font-size:12px; opacity:0.9; margin-right:8px;">${escapeHtml(task.dueDate)}</span>` : '';
    li.innerHTML = `
      <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${tIdx})">
      <input type="text" value="${escapeHtml(task.text)}" onchange="editTask(${tIdx}, this.value)" style="text-decoration: ${task.done ? 'line-through' : 'none'}; margin-left:8px; flex:1;">
      ${dateLabel}
      <button onclick="deleteTask(${tIdx})">🗑️</button>
    `;
    ul.appendChild(li);
  });
}

/* Task operations */
function createNewList() { allLists.push({ name: `List ${allLists.length+1}`, tasks: [] }); saveAllLists(); activeListIndex = allLists.length-1; renderLists(); }
function renameList(listIndex) { const newName = prompt("New name:", allLists[listIndex].name || `List ${listIndex+1}`); if (newName && newName.trim()!=="") { allLists[listIndex].name=newName.trim(); saveAllLists(); renderLists(); } }
function confirmDeleteList(listIndex) { if(!confirm("Delete this list?")) return; allLists.splice(listIndex,1); if(allLists.length===0) activeListIndex=0; else if(activeListIndex>=allLists.length) activeListIndex=allLists.length-1; saveAllLists(); renderLists(); }
function addTask(listIndex) {
  const input = document.getElementById(`newTask_${listIndex}`);
  const dateInput = document.getElementById(`newTaskDate_${listIndex}`);
  const text = input.value.trim();
  const dueDate = dateInput ? dateInput.value : '';

  if (!text) return;

  // Add to the to-do list (keeps compatibility with previous shape)
  allLists[listIndex].tasks.push({ text, done: false, dueDate: dueDate || undefined });
  input.value = "";
  if (dateInput) dateInput.value = "";

  // If a due date was provided, add to planner (dated items)
  if (dueDate && currentUser) {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    users[currentUser] = users[currentUser] || {};
    users[currentUser].planner = users[currentUser].planner || [];
    users[currentUser].planner.push({ text, date: dueDate });
    localStorage.setItem('users', JSON.stringify(users));
    renderPlanner();
  }

  saveAllLists();
  renderLists();
}
function toggleTask(taskIndex) { allLists[activeListIndex].tasks[taskIndex].done = !allLists[activeListIndex].tasks[taskIndex].done; saveAllLists(); renderLists(); }
function editTask(taskIndex, newText) { allLists[activeListIndex].tasks[taskIndex].text=newText; saveAllLists(); }
function deleteTask(taskIndex) { allLists[activeListIndex].tasks.splice(taskIndex,1); saveAllLists(); renderLists(); }

function checkTopPanelsVisibility() {
  const topPanels = document.getElementById('topPanels');
  const quickLinks = document.getElementById('quickLinks');
  const planner = document.getElementById('planner');

  if (!currentUser) {
    // No user logged in → hide everything
    topPanels.classList.add('hidden');
    topPanels.setAttribute('aria-hidden', 'true');
    quickLinks.classList.add('hidden');
    planner.classList.add('hidden');
  } else {
    // User is logged in → show panels if they’re supposed to be visible
    topPanels.classList.remove('hidden');
    topPanels.setAttribute('aria-hidden', 'false');

    // Only show individual panels if they have content
    if ((quickLinks.querySelector('ul')?.children.length || 0) > 0) {
      quickLinks.classList.remove('hidden');
    } else {
      quickLinks.classList.add('hidden');
    }

    if ((planner.querySelector('ul')?.children.length || 0) > 0) {
      planner.classList.remove('hidden');
    } else {
      planner.classList.add('hidden');
    }
  }
}


function logout() {
  localStorage.removeItem('currentUser');
  currentUser = null;
  document.getElementById('todo').classList.add('hidden');
  document.getElementById('signup').classList.remove('hidden');
  checkTopPanelsVisibility();
}


</script>
</body>
</html>




