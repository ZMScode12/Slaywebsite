<script>
/* --------- State --------- */
let currentUser = localStorage.getItem('currentUser');
let allLists = [];               // array of { name: string, tasks: [{text,done}] }
let activeListIndex = 0;
let pickedBackground = 'default'; // 'default' keeps moving gradient, otherwise a CSS gradient string

/* --------- Helpers for gradients UI --------- */
const gradientEls = Array.from(document.querySelectorAll('.gradient-option'));

function setPickedBgValue(val) {
  pickedBackground = val;

  // update visual selection
  gradientEls.forEach(el => el.classList.toggle('selected', el.getAttribute('data-bg') === val));

  // preview immediately
  applyBackgroundPreview(val);
}

function applyBackgroundPreview(val) {
  if (val === 'default') {
    document.body.style.background = getComputedStyle(document.documentElement).getPropertyValue('--default-moving').trim();
    document.body.style.backgroundSize = '400% 400%';
    document.body.style.animation = 'gradientMove 12s ease infinite';
  } else {
    document.body.style.background = val;
    document.body.style.backgroundSize = '';
    document.body.style.animation = '';
  }
}

// wire up clicks for signup gradient options
gradientEls.forEach(el => el.addEventListener('click', () => {
  const val = el.getAttribute('data-bg');
  setPickedBgValue(val);
}));

function useDefaultNow() {
  setPickedBgValue('default');
}

/* Initialize signup preview ‚Äî default selected */
setPickedBgValue('default');

/* --------- Load existing session --------- */
if (currentUser) {
  loadAllLists();
  showTodo();
  renderLists();
}

/* --------- Account functions --------- */
function createAccount() {
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!user || !pass) { alert('Please fill both username and password'); return; }

  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (users[user]) { alert('Username exists'); return; }

  users[user] = {
    password: pass,
    lists: [{ name: 'My First List', tasks: [] }],
    background: pickedBackground
  };

  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('currentUser', user);
  currentUser = user;

  loadAllLists();
  showTodo();
  renderLists();
}

function showLogin() {
  document.getElementById('signup').classList.add('hidden');
  document.getElementById('login').classList.remove('hidden');
}

function showSignup() {
  document.getElementById('login').classList.add('hidden');
  document.getElementById('signup').classList.remove('hidden');
}

function login() {
  const user = document.getElementById('loginUsername').value.trim();
  const pass = document.getElementById('loginPassword').value.trim();
  const users = JSON.parse(localStorage.getItem('users') || '{}');

  if (!users[user] || users[user].password !== pass) {
    alert('Invalid username or password');
    return;
  }

  localStorage.setItem('currentUser', user);
  currentUser = user;

  loadAllLists();
  showTodo();
  renderLists();
}

/* --------- show/hide and background application --------- */
function showTodo() {
  if (!currentUser) return;
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  const user = users[currentUser];
  const bg = user.background || 'default';
  applyBackgroundPreview(bg);

  document.getElementById('signup').classList.add('hidden');
  document.getElementById('login').classList.add('hidden');
  document.getElementById('todo').classList.remove('hidden');

  document.getElementById('todoHeader').innerHTML = `
    <h1>Welcome, ${currentUser}!</h1>
    <div style="margin-top:8px">
      <button onclick="createNewList()" class="list-button">+ New To-Do List</button>
      <button class="control-small" onclick="openBackgroundPicker()">Change background</button>
    </div>
  `;
}

/* --------- Background picker modal --------- */
function openBackgroundPicker() {
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.top = '0';
  overlay.style.left = '0';
  overlay.style.width = '100%';
  overlay.style.height = '100%';
  overlay.style.background = 'rgba(0,0,0,0.7)';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = '9999';

  const pickerBox = document.createElement('div');
  pickerBox.style.background = 'rgba(255,255,255,0.15)';
  pickerBox.style.padding = '20px';
  pickerBox.style.borderRadius = '14px';
  pickerBox.style.color = 'white';
  pickerBox.style.textAlign = 'center';
  pickerBox.style.boxShadow = '0 0 20px rgba(0,0,0,0.4)';

  pickerBox.innerHTML = `
    <h2>Choose a new background ‚ú®</h2>
    <div id="gradientChoices" style="margin-top:12px"></div>
    <button style="margin-top:12px;padding:8px 14px;border:none;border-radius:8px;cursor:pointer;">
      Close
    </button>
  `;

  const closeBtn = pickerBox.querySelector('button');
  closeBtn.onclick = () => document.body.removeChild(overlay);

  overlay.appendChild(pickerBox);
  document.body.appendChild(overlay);

  const choiceDiv = pickerBox.querySelector('#gradientChoices');
  const gradients = Array.from(document.querySelectorAll('.gradient-option'));
  gradients.forEach(g => {
    const clone = g.cloneNode(true);
    clone.style.margin = '6px';
    clone.onclick = () => {
      const val = clone.getAttribute('data-bg');
      setPickedBgValue(val);

      // save permanently for logged-in user
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (currentUser && users[currentUser]) {
        users[currentUser].background = val;
        localStorage.setItem('users', JSON.stringify(users));
      }
    };
    choiceDiv.appendChild(clone);
  });

  // pre-select current background
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  const bg = (users[currentUser] && users[currentUser].background) || 'default';
  setPickedBgValue(bg);
}

/* --------- Logout --------- */
function logout() {
  saveAllLists();
  localStorage.removeItem('currentUser');
  currentUser = null;
  allLists = [];
  activeListIndex = 0;

  setPickedBgValue('default');

  document.getElementById('todo').classList.add('hidden');
  document.getElementById('login').classList.remove('hidden');
  document.getElementById('listsContainer').innerHTML = "";
  document.getElementById('tabsContainer').innerHTML = "";
  document.getElementById('todoHeader').innerHTML = "";
}

/* --------- Save / Load user lists --------- */
function saveAllLists() {
  if (!currentUser) return;
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  users[currentUser].lists = allLists;
  localStorage.setItem('users', JSON.stringify(users));
}

function loadAllLists() {
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if (!currentUser || !users[currentUser]) { allLists = []; return; }
  allLists = users[currentUser].lists || [];
  allLists = allLists.map(l => (typeof l === 'string' ? { name: l, tasks: [] } : (l.name ? l : { name: 'Untitled', tasks: l.tasks || [] })));
  activeListIndex = 0;
}

/* --------- Render Tabs & Lists --------- */
function renderLists() {
  renderTabs();
  renderActiveList();
}

function renderTabs() {
  const tabs = document.getElementById('tabsContainer');
  tabs.innerHTML = "";

  allLists.forEach((list, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (i === activeListIndex ? ' active' : '');
    btn.textContent = list.name || `List ${i+1}`;
    btn.onclick = () => { activeListIndex = i; renderLists(); };
    tabs.appendChild(btn);

    const renameBtn = document.createElement('button');
    renameBtn.className = 'control-small';
    renameBtn.textContent = '‚úèÔ∏è';
    renameBtn.onclick = e => { e.stopPropagation(); renameList(i); };
    tabs.appendChild(renameBtn);

    const delBtn = document.createElement('button');
    delBtn.className = 'control-small';
    delBtn.textContent = 'üóë';
    delBtn.onclick = e => { e.stopPropagation(); confirmDeleteList(i); };
    tabs.appendChild(delBtn);
  });
}

function renderActiveList() {
  const container = document.getElementById('listsContainer');
  container.innerHTML = "";

  if (allLists.length === 0) {
    container.innerHTML = `<div style="padding:20px; border-radius:12px; background: rgba(0,0,0,0.15)">
      <h2>No To-Do Lists Yet üòé</h2>
      <p>Click "+ New To-Do List" to start.</p>
    </div>`;
    return;
  }

  const index = activeListIndex;
  const list = allLists[index];
  const listDiv = document.createElement('div');

  listDiv.innerHTML = `
    <h2 style="margin-bottom:6px">${list.name}</h2>
    <div style="margin-bottom:8px">
      <input type="text" id="newTask_${index}" placeholder="Add a task...">
      <button onclick="addTask(${index})">Add</button>
    </div>
    <ul id="list_${index}"></ul>
  `;
  container.appendChild(listDiv);

  const ul = document.getElementById(`list_${index}`);
  list.tasks.forEach((task, tIdx) => {
    const li = document.createElement('li');
    li.innerHTML = `
      <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${tIdx})">
      <input type="text" value="${escapeHtml(task.text)}" onchange="editTask(${tIdx}, this.value)">
      <button onclick="deleteTask(${tIdx})">üóëÔ∏è</button>
    `;
    ul.appendChild(li);
  });
}

/* --------- List & Task operations --------- */
function createNewList() {
  const name = `List ${allLists.length + 1}`;
  allLists.push({ name, tasks: [] });
  saveAllLists();
  activeListIndex = allLists.length - 1;
  renderLists();
}

function renameList(listIndex) {
  const currentName = allLists[listIndex].name || `List ${listIndex+1}`;
  const newName = prompt("Enter a new name for this list:", currentName);
  if (newName && newName.trim() !== "") {
    allLists[listIndex].name = newName.trim();
    saveAllLists();
    renderLists();
  }
}

function confirmDeleteList(listIndex) {
  if (!confirm("Are you sure you want to delete this list and all its tasks?")) return;
  allLists.splice(listIndex, 1);
  if (allLists.length === 0) activeListIndex = 0;
  else if (activeListIndex >= allLists.length) activeListIndex = allLists.length - 1;
  saveAllLists();
  renderLists();
}

function addTask(listIndex) {
  const input = document.getElementById(`newTask_${listIndex}`);
  const text = input.value.trim();
  if (!text) return;
  allLists[listIndex].tasks.push({ text, done: false });
  input.value = "";
  saveAllLists();
  renderLists();
}

function toggleTask(taskIndex) {
  const list = allLists[activeListIndex];
  list.tasks[taskIndex].done = !list.tasks[taskIndex].done;
  saveAllLists();
  renderLists();
}

function editTask(taskIndex, newText) {
  allLists[activeListIndex].tasks[taskIndex].text = newText;
  saveAllLists();
}

function deleteTask(taskIndex) {
  allLists[activeListIndex].tasks.splice(taskIndex, 1);
  saveAllLists();
  renderLists();
}

/* --------- Small util --------- */
function escapeHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}
</script>
